<html>
    <head>
        <script src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
        <script src="https://fastly.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
    </head>
<body>
    <h1>TI Oracle Node</h1>
    <ul>
        <li>
            <a href="/pairs.html">Trading Pairs</a>
        </li>
        <li>
            <a href="/events.html">OnChain Events</a>
        </li>
        <li>
            <a target="_blank" href="https://polygonscan.com/address/0xfaaa1887a03e4df74f129dc02fa638f4563b0d06#readContract">Smart Contract</a>
        </li>
    </ul>
    <hr/>
    <h3>
        <div id="info"></div>
    </h3>
    <div id="container" style="height: 60%; width: 75%;"></div>
    <script type="text/javascript">
        var dom = document.getElementById('container');
        var myChart = echarts.init(dom, null, {
          renderer: 'canvas',
          useDirtyRect: false
        });
        var app = {};
        var option;
        var date = [];
        var data = [];
        function addData(shift) {
            $.get("/events", function (result){
                N = result.length;
                for(i=0;i<N;i++) {
                    chain_event = result[i];
                    //console.log(chain_event);
                    $('#info').text("Coin:"+chain_event.coin_name + "; Round:" + chain_event.round + "; Count:" + chain_event.feed_count);
                    date.push(chain_event.feed_count);
                    var m = Math.round(chain_event.peers_report.length/2);
                    var price = chain_event.peers_report[0].price/1e8;
                    data.push(price.toFixed(2));
                    if(shift) {
                        date.shift();
                        data.shift();
                    }
                }
            });
        }

        option = {
            xAxis: {
                //type: 'category',
                boundaryGap: false,
                data: date
            },
            yAxis: {
                boundaryGap: [0, '50%'],
                type: 'value',
                axisLabel: {
                    formatter: '${value}'
                }
            },
            tooltip : {
                trigger: 'axis',
                axisPointer: {
                type: 'cross',
                label: {
                    backgroundColor: '#6a7985'
                }
                }
            },
            series: [
                {
                name: 'price',
                type: 'line',
                smooth: true,
                //symbol: 'none',
                stack: 'a',
                areaStyle: {
                    normal: {}
                },
                data: data
                }
            ]
        };
        addData(false);
        setInterval(function () {
            addData(true);
            myChart.setOption({
                xAxis: {
                data: date
                },
                series: [
                {
                    name: 'price',
                    data: data
                }
                ]
            });
        }, 500);

        if (option && typeof option === 'object') {
          myChart.setOption(option);
        }

        window.addEventListener('resize', myChart.resize);
      </script>
</body>

</html>